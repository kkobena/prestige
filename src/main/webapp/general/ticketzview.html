<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Ticket Z</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./iframe/resources/css/bootstrap.min.css" />
    <style>
      #spinner { margin: 20rem !important; }
      .card { padding-left: 3px; padding-right: 3px; margin-top: 3px; }
      .card-body { padding: 5px 3px 2px 3px; }
      .col { padding-left: 5px; padding-right: 5px; }
      .col-md-4 { padding-left: 0.2rem; padding-right: 0.2rem; }
      .col-md-3 { padding-right: calc(var(--bs-gutter-x) * .2); padding-left: calc(var(--bs-gutter-x) * .2); }

      /* Table : valeur (dernière colonne) alignée à droite, non coupée */
      table tr td:first-child { text-align: left; }
      table tr td:last-child {
        text-align: right;
        font-weight: 700;
        white-space: nowrap;            /* empêche le retour à la ligne */
        font-variant-numeric: tabular-nums;
      }

      /* Mise en page A4 pour l'impression */
      @page { size: A4 portrait; margin: 12mm; }
      .print-page { max-width: 210mm; margin: 0 auto; }
      .print-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 6px;
      }
      .brand { display: flex; align-items: center; gap: 10px; }
      .brand img { width: 42px; height: 42px; object-fit: contain; }
      .brand-name { font-weight: 700; font-size: 16px; line-height: 1; }
      .brand-sub { font-size: 12px; color: #666; }
      .avatar {
        width: 42px; height: 42px; border-radius: 50%; background: #0d6efd; color: #fff;
        display: flex; align-items: center; justify-content: center; font-weight: 700;
      }
      .meta { font-size: 12px; color: #555; }
      .period { font-weight: 600; }

      /* N'imprimer que la zone #printable */
      @media print {
        body * { visibility: hidden !important; }
        #printable, #printable * { visibility: visible !important; }
        #printable { position: absolute; left: 0; top: 0; width: 100%; }
        .btn, .card .btn-group { display: none !important; }
        table tr td:last-child { white-space: nowrap; }
      }
    </style>
  </head>
  <body>
    <!-- JS de base -->
    <script src="./iframe/resources/js/jquery.min.js"></script>
    <script src="./iframe/resources/js/bootstrap.js"></script>

    <div class="container-fluid row">
      <!-- Filtres -->
      <div class="col-md-2 p-1">
        <div class="card">
          <div class="card-body">
            <div class="mb-3">
              <label for="description" class="form-label">Type</label>
              <select id="description" class="form-select">
                <option selected value="ALL">Tous les mouvements</option>
                <option value="VENTE">Ventes uniquement</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="userId" class="form-label">Utilisateurs</label>
              <select id="userId" class="form-select">
                <option selected value="ALL">Tout</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="dtStart" class="form-label">Date début</label>
              <input class="form-control" type="date" id="dtStart" />
            </div>

            <!-- Heures éditables -->
            <div class="mb-3">
              <label for="hrStart" class="form-label">Heure début</label>
              <input id="hrStart" type="time" class="form-control"
                     value="00:00" step="60" placeholder="HH:MM"
                     pattern="^[0-2]\\d:[0-5]\\d$" />
            </div>

            <div class="mb-3">
              <label for="dtEnd" class="form-label">Date fin</label>
              <input class="form-control" type="date" id="dtEnd" />
            </div>

            <div class="mb-3">
              <label for="hrEnd" class="form-label">Heure fin</label>
              <input id="hrEnd" type="time" class="form-control"
                     value="23:59" step="60" placeholder="HH:MM"
                     pattern="^[0-2]\\d:[0-5]\\d$" />
            </div>

            <div class="card-body">
                <!-- Colonne : groupe (3) puis Aperçu centré dessous -->
                <div class="d-flex flex-column">
                    <!-- Les 3 boutons sur la même ligne -->
                    <div class="btn-group" role="group">
                        <button id="afficher" type="button" class="btn btn-outline-primary btn-sm">Afficher</button>
                        <button id="send-sms" type="button" class="btn btn-outline-warning btn-sm">Envoyer SMS</button>
                        <button id="imprimer" type="button" class="btn btn-outline-success btn-sm">Imprimer</button>
                    </div>

                    <!-- Bouton Aperçu centré avec icône œil -->
                    <div class="d-flex justify-content-center mt-2">
                        <button id="preview" type="button" class="btn btn-outline-secondary btn-sm">
                            <svg class="bi me-1" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true">
                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8z"/>
                            <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                            </svg>
                            Aperçu
                        </button>
                    </div>
                </div>
            </div>



          </div>
        </div>
      </div>

      <div class="col-md-10 p-1 row" id="ticket-container"></div>
    </div>

    <div id="printable" class="d-none"></div>

    <script>
      const BRAND = { name: 'Pharmacie', owner: '', logo: '' };

      function initialsOf(str = '') {
        return str.trim().split(/\s+/).slice(0, 2).map(s => s[0]?.toUpperCase() || '').join('') || 'PH';
      }

      async function loadOfficineInfo() {
        const url = 'http://localhost:8080/prestige/api/v1/officine';
        try {
          const cached = sessionStorage.getItem('officineInfo');
          if (cached) {
            const arr = JSON.parse(cached);
            if (arr && arr.length) applyOfficine(arr[0]);
          } else {
            const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
            if (res.ok) {
              const data = await res.json();
              if (Array.isArray(data) && data.length) {
                sessionStorage.setItem('officineInfo', JSON.stringify(data));
                applyOfficine(data[0]);
              }
            }
          }
        } catch (e) {
          console.warn('Officine API non disponible:', e.message);
        }
      }

      function applyOfficine(o) {
        BRAND.name  = o.nomComplet || o.fullName || BRAND.name;
        BRAND.owner = o.fullName   || '';
      }

      function pad2(n) { n = String(n); return n.length === 1 ? ('0' + n) : n; }
      function getTimeValue(id, fallback) {
        const el = document.getElementById(id);
        if (!el) return fallback;
        let v = (el.value || '').trim();
        if (/^\d:[0-5]\d$/.test(v)) v = '0' + v;   // 8:05 -> 08:05
        if (!/^\d{2}:[0-5]\d$/.test(v)) return fallback;
        const [h, m] = v.split(':');
        return pad2(parseInt(h, 10)) + ':' + m;
      }
      function fmtDateFr(iso) {
        if (!iso) return '';
        const [y, m, d] = iso.split('-');
        return `${d}/${m}/${y}`;
      }
      function buildPeriodText() {
        const d1 = document.getElementById('dtStart').value;
        const d2 = document.getElementById('dtEnd').value;
        const h1 = getTimeValue('hrStart', '00:00');
        const h2 = getTimeValue('hrEnd', '23:59');
        const type = document.getElementById('description').value;
        const user = document.getElementById('userId').value;

        const typeTxt = (type === 'ALL' ? 'Tous les mouvements' : 'Ventes uniquement');
        const userTxt = (user === 'ALL' ? 'Tous utilisateurs' : `Utilisateur: ${user}`);

        return {
          human: `Période : du ${fmtDateFr(d1)} ${h1} au ${fmtDateFr(d2)} ${h2}`,
          meta: `${typeTxt} — ${userTxt}`
        };
      }

      function protectNumbers(html) {
        return html.replace(/(\d{1,3}(?:\s\d{3})+)/g, m => m.replace(/\s/g, '&nbsp;'));
      }

      function buildPrintHeaderHTML() {
        const p = buildPeriodText();
        const nowFr = new Date().toLocaleString('fr-FR');
        const avatarHTML = BRAND.logo
          ? `<img src="${BRAND.logo}" alt="Logo" />`
          : `<div class="avatar">${initialsOf(BRAND.name || BRAND.owner)}</div>`;
        return `
          <div class="print-header">
            <div class="brand">
              ${avatarHTML}
              <div>
                <div class="brand-name">${BRAND.name}</div>
                <div class="brand-sub">${BRAND.owner ? 'Resp. : ' + BRAND.owner : 'Ticket Z — Récapitulatif'}</div>
              </div>
            </div>
            <div class="meta" style="text-align:right">
              Imprimé le ${nowFr}<br />
              <span class="period">${p.human}</span><br />
              <span class="meta">${p.meta}</span>
            </div>
          </div>
        `;
      }

      document.getElementById('preview').addEventListener('click', function () {
        const header = buildPrintHeaderHTML();
        let body = document.getElementById('ticket-container').innerHTML || '<p style="padding:1rem">Aucune donnée à afficher.</p>';
        body = protectNumbers(body); // fige les nombres

        const w = window.open('', 'PRINT_PREVIEW', 'width=1024,height=768');
        if (!w) { alert('Veuillez autoriser les pop-ups pour l’aperçu.'); return; }
        w.document.open();
        w.document.write(`<!doctype html>
                <html lang="fr">
                <head>
                  <meta charset="utf-8">
                  <title>Aperçu - Ticket Z</title>
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <link rel="stylesheet" href="./iframe/resources/css/bootstrap.min.css">
                  <style>
                    @page { size: A4 portrait; margin: 12mm; }
                    body{ margin:0; padding:1rem; }
                    .print-page{ max-width:210mm; margin:0 auto; }
                    .print-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:6px; }
                    .brand{display:flex;align-items:center;gap:10px}
                    .brand img{width:42px;height:42px;object-fit:contain}
                    .brand-name{font-weight:700;font-size:16px;line-height:1}
                    .brand-sub{font-size:12px;color:#666}
                    .meta{ font-size:12px; color:#555; }
                    .period{ font-weight:600; }
                    /* Empêche la coupure des chiffres dans l'aperçu */
                    table tr td:last-child{ white-space:nowrap; font-variant-numeric:tabular-nums; }
                    @media print{ .no-print{ display:none !important; } body{ padding:0; } }
                  </style>
                </head>
                <body>
                  <div class="no-print mb-2">
                    <button onclick="window.print()" class="btn btn-success btn-sm">Imprimer</button>
                    <button onclick="window.close()" class="btn btn-outline-secondary btn-sm">Fermer</button>
                  </div>
                  <div class="print-page">
            ${header}
            ${body}
          </div>
        </body>
        </html>`);
        w.document.close();
        w.focus();
      });

      document.addEventListener('DOMContentLoaded', loadOfficineInfo);
    </script>

    <script src="./iframe/resources/js/ticketZ.js"></script>
  </body>
</html>
